const ws = new WebSocket('ws://localhost:3000');
ws.binaryType = 'arraybuffer';

const audioCtx = new AudioContext();

ws.onmessage = (event) => {
  const buffer = event.data; // ArrayBuffer de données PCM

  // Créer un AudioBuffer à partir du PCM reçu
  // Supposons 16 bits PCM interleaved stéréo, 48000Hz

  // Convertir ArrayBuffer en Int16Array
  const int16Array = new Int16Array(buffer);

  // Convertir Int16Array [-32768,32767] vers Float32Array [-1.0,1.0]
  const float32Array = new Float32Array(int16Array.length);
  for(let i = 0; i < int16Array.length; i++) {
    float32Array[i] = int16Array[i] / 32768;
  }

  // Créer un AudioBuffer
  const numberOfChannels = 1;
  const frameCount = float32Array.length / numberOfChannels;

  const audioBuffer = audioCtx.createBuffer(
    numberOfChannels,
    frameCount,
    48000
  );

  // Séparer les canaux
  for(let channel = 0; channel < numberOfChannels; channel++) {
    const channelData = audioBuffer.getChannelData(channel);
    for(let i = 0; i < frameCount; i++) {
      channelData[i] = float32Array[i * numberOfChannels + channel];
    }
  }

  // Jouer le buffer
  const source = audioCtx.createBufferSource();
  source.buffer = audioBuffer;
  source.connect(audioCtx.destination);
  source.start();
};
